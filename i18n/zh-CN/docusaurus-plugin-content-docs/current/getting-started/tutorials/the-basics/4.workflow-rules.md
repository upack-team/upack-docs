# 第4课: 工作流规则

在本节中，我们将深入了解 Steedos 中的自动化功能，如何利用工作流规则来自动执行任务。我们将通过一个实际的案例——创建一个工作流规则，该规则在任务（例如，`Todos` 对象）被创建、修改或删除时向指派人（`Assignees`）发送提醒。

## 目标

- 理解工作流规则的基本概念和应用。
- 学习如何在 Steedos 中创建和管理工作流规则。
- 掌握使用工作流规则自动化任务通知的技巧。

##  **工作流规则简介**

工作流规则是 Steedos 中一个强大的自动化工具，允许用户根据特定条件自动执行预定义的动作。这些规则是提高效率、确保数据一致性和自动化重复任务的关键。
- **定义**: 工作流规则是基于一系列条件的业务逻辑，当这些条件满足时，会触发一或多个动作，如更新字段、发送邮件、创建任务等。
- **重要性**: 它们极大地简化了日常任务，减少了手动处理的需要，同时确保业务过程的准确性和一致性。

### **功能**
- **自动化任务**: 自动执行常见的业务任务，如数据更新、记录创建和发送通知。
- **条件触发**: 可以基于记录字段的变更、特定日期或甚至公式的结果来触发。
- **动作执行**: 执行各种动作，包括发送电子邮件通知、更新记录的字段或创建新的记录。

### **工作流规则与触发器的比较**
- **工作流规则** 相对简单，适用于直接的条件动作模型。
- **触发器** 适用于需要编码实现的复杂业务逻辑。

### **应用场景**
- **数据管理**: 如自动更新记录的状态或字段。
- **通知和提醒**: 如任务截止前自动发送提醒邮件给相关人员。
- **业务规则执行**: 如基于特定条件自动分配任务或资源。

工作流规则是 Steedos 中实现自动化的基石，适用于各种业务场景，从简单的数据更新到复杂的业务逻辑处理。了解和掌握工作流规则对于有效使用 Steedos 平台至关重要。

## **创建工作流规则的步骤**
   - 选择对象并开始创建规则
   - 定义触发条件
   - 设置动作（如发送邮件、创建任务等）

## **案例实操：新任务提醒工作流规则**

   **场景描述**:
   
   当 `Todos` 对象的任务被创建、修改时，需要向任务的指派人(Assignees)发送提醒。

   1. **进入 设置**:
      - 从 Steedos 主界面进入 `设置` 区域。
      - 创建 `Todos` 对象

   2. **创建新的工作流规则**:
      - 在 `工作流规则` 部分，选择 `新建`。
      - 选择 `Todos` 对象。

   3. **设置规则条件**:
      - 规则名称：例如 `Todo Assignment Notification`。
      - API Name: 例如：`todo_asssignment_notification`。
      - 评估条件：选择 `新建时，和每次编辑时`，来确保每次编辑时都会评估条件。
      - 规则条件：使用公式 `TRUE`，表示任何创建或编辑操作都会触发规则。

   4. **添加消息提醒动作**:
      - 选中 `消息提醒`，点击 `新建`，创建一个新的消息提醒。
      - API 名称: 例如：`todo_asssignment_notification`。
      - 显示名称：例如 `Todo Assignment Notification`。
      - 选择对象为`Todos`。
      - 设置通知标题公式：`"您有新任务"`
      - 设置通知正文公式：`name`
      - 选择分配的用户，点击 `指定对象上的用户字段`，选择 `Assignees` 字段作为消息接收人。

   5. **保存并激活规则**:
      - 在工作流规则`即时操作`中，选择刚刚创建的`消息提醒`
      - 选择启用工作流规则
      - 确认设置后保存。

   6. **测试规则**:
      - 在测试环境中测试创建和修改 `Todos` 记录时消息是否正确发送。

## **案例实操：任务到期提醒工作流规则**
   
   **场景描述**:

   所有待办任务，在任务到期日之前三天发送提醒给任务处理人。

   1. **进入 设置**:
      - 从 Steedos 主界面进入 `设置` 区域。
      - 创建 `Todos` 对象
      - 创建字段 `due_date`（截止日期） 和 `is_done`（已完成）。

   2. **创建新的工作流规则**:
      - 在 `工作流规则` 部分，选择 `新建`。
      - 选择 `Todos` 对象。

   3. **设置规则条件**:
      - 规则名称：例如 `Todo Due Date Notification`。
      - API Name: 例如：`todo_due_date_notification`。
      - 评估条件：选择 `新建时，和编辑数据导致条件成立时`。

   4. **添加消息提醒动作**:
      - 选中 `消息提醒`，点击 `新建`，创建一个新的消息提醒。
      - API 名称: 例如：`todo_due_date_notification`。
      - 显示名称：例如 `Todo Due Date Notification`。
      - 选择对象为`Todos`。
      - 设置通知标题公式：`"您的任务还有三天到期"`
      - 设置通知正文公式：`name`
      - 选择分配的用户，点击 `指定对象上的用户字段`，选择 `Assignees` 字段作为消息接收人。

   5. **创建依赖于时间的工作流操作**:
      - 过滤条件：设置规则的条件来检测任务是否未完成且接近截止日期。假设 is_done 字段用来表示任务是否完成，你可以使用类似以下的条件公式：
      ```js
      ['is_done__c', '!=', true]
      ```
      - 新增时间触发器
         - 数值：3
         - 单位：天
         - 类型：早于
         - 字段：Due Date
         - 工作流操作：选择刚刚创建的`消息提醒`：`Todo Due Date Notification`
      - 选择启用工作流规则
      - 确认设置后保存。

   6. **测试规则**:
      - 在测试环境中测试创建和修改 `Todos` 记录时消息是否正确发送。

## 结语
通过本节课程，你将能够理解和应用 Steedos 中的工作流规则，以提高业务流程的自动化和效率。记得实际操作是最好的学习方式，因此强烈推荐在沙盒环境中实践本节课程内容。

## 课后练习
- 在开发环境中创建一个新的 `Todos` 任务，并观察是否收到了预期的邮件提醒。
- 尝试修改工作流规则，加入新的条件，例如只在指派人不等于自己时，才触发提醒。
